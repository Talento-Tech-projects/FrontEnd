<!-- src/app/sites/beam-analysis/beam-analysis.html -->

<div class="grid h-screen grid-cols-1 grid-rows-[auto_1fr] md:grid-cols-[450px_1fr] md:grid-rows-1 gap-4 p-4 bg-gray-100 font-sans">

    <!-- Columna Izquierda: Controles y Entradas -->
    <aside class="bg-white p-4 rounded-lg shadow-lg overflow-y-auto flex flex-col gap-4">
        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Parámetros del Análisis</h2>

        <!-- Propiedades Globales de la Viga -->
        <div class="space-y-3 p-3 border rounded-lg bg-gray-50/50">
            <h3 class="font-semibold text-gray-700">Propiedades de la Viga</h3>
            <div>
                <label for="beamLength" class="block text-sm font-medium text-gray-600">Longitud (m)</label>
                <input type="number" id="beamLength" [(ngModel)]="beamLength" (change)="redrawKonva()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="beamE" class="block text-sm font-medium text-gray-600">Módulo de Young (E) [Pa]</label>
                <input type="text" id="beamE" [(ngModel)]="beamE" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="beamI" class="block text-sm font-medium text-gray-600">Momento de Inercia (I) [m⁴]</label>
                <input type="text" id="beamI" [(ngModel)]="beamI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
        </div>

        <!-- Añadir Apoyos -->
        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Añadir Apoyo</h3>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label for="supportPos" class="block text-sm font-medium text-gray-600">Posición (m)</label>
                    <input type="number" id="supportPos" [(ngModel)]="supportPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="supportType" class="block text-sm font-medium text-gray-600">Tipo</label>
                    <select id="supportType" [(ngModel)]="supportType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="PINNED">Articulado (Pinned)</option>
                        <option value="ROLLER">Rodillo (Roller)</option>
                        <option value="FIXED">Empotrado (Fixed)</option>
                    </select>
                </div>
            </div>
            <button (click)="addSupport()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Añadir Apoyo</button>
        </div>

        <!-- Añadir Cargas Puntuales -->
        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Añadir Carga Puntual</h3>
            <div class="grid grid-cols-2 gap-2">
                 <div>
                    <label for="loadPos" class="block text-sm font-medium text-gray-600">Posición (m)</label>
                    <input type="number" id="loadPos" [(ngModel)]="loadPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="loadMag" class="block text-sm font-medium text-gray-600">Magnitud (kN)</label>
                    <input type="number" id="loadMag" [(ngModel)]="loadMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Positivo hacia abajo">
                </div>
            </div>
            <button (click)="addPointLoad()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Añadir Carga</button>
        </div>

        <!-- Formulario para Momentos Puntuales -->
        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Añadir Momento Puntual</h3>
            <div class="grid grid-cols-2 gap-2">
                 <div>
                    <label for="momentPos" class="block text-sm font-medium text-gray-600">Posición (m)</label>
                    <input type="number" id="momentPos" [(ngModel)]="momentPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="momentMag" class="block text-sm font-medium text-gray-600">Magnitud (kNm)</label>
                    <input type="number" id="momentMag" [(ngModel)]="momentMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Anti-horario positivo">
                </div>
            </div>
            <button (click)="addPointMoment()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Añadir Momento</button>
        </div>

        <!-- Formulario para Cargas Distribuidas -->
        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Añadir Carga Distribuida</h3>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium text-gray-600">Pos. Inicial (m)</label>
                    <input type="number" [(ngModel)]="distLoadStartPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Pos. Final (m)</label>
                    <input type="number" [(ngModel)]="distLoadEndPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Mag. Inicial (kN/m)</label>
                    <input type="number" [(ngModel)]="distLoadStartMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Mag. Final (kN/m)</label>
                    <input type="number" [(ngModel)]="distLoadEndMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <button (click)="addDistributedLoad()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Añadir Carga Dist.</button>
        </div>

        <!-- Botones de Acción -->
        <div class="mt-auto pt-4 border-t space-y-2">
            <button (click)="calculate()" [disabled]="isLoading" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-blue-400 disabled:cursor-not-allowed shadow-md">
                {{ isLoading ? 'Calculando...' : 'Calcular Resultados' }}
            </button>
             <button (click)="resetModel()" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-md">
                Reiniciar Modelo
            </button>
        </div>
    </aside>

    <!-- Columna Derecha: Visualización y Resultados -->
    <main class="bg-white p-4 rounded-lg shadow-lg overflow-y-auto flex flex-col gap-4">
        <!-- Visualización Konva -->
        <div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Visualización del Modelo</h2>
            <div #konvaContainer class="w-full h-[150px] bg-gray-50 border rounded-lg"></div>
        </div>

        <!-- Sección de Resultados -->
        <div class="flex-grow flex flex-col min-h-[400px]">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Resultados del Análisis</h2>
            
            <!-- Mensaje de Error -->
            <div *ngIf="errorResult" class="p-4 mb-4 text-sm text-red-800 bg-red-100 rounded-lg" role="alert">
                <span class="font-bold">Error en el cálculo:</span> {{ errorResult }}
            </div>
            
            <!-- Contenedor de Gráficas y Reacciones -->
            <div *ngIf="results && !errorResult" class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="relative h-64 border rounded-md p-2"><canvas #shearChartCanvas></canvas></div>
                <div class="relative h-64 border rounded-md p-2"><canvas #momentChartCanvas></canvas></div>
                <div class="relative h-64 border rounded-md p-2"><canvas #deflectionChartCanvas></canvas></div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h3 class="font-semibold mb-2">Reacciones en Apoyos</h3>
                    <ul class="text-sm space-y-2 font-mono">
                        <li *ngFor="let reaction of (results?.reactions | keyvalue)">
                           <div class="bg-gray-200/60 p-2 rounded-md">
                               <div class="font-bold">&#64; {{reaction.key | number:'1.2-2'}} m</div>
                                <div class="pl-2">
                                    <span>Fx: {{reaction.value.Fx | number:'1.2-2'}} kN</span><br>
                                    <span>Fy: {{reaction.value.Fy | number:'1.2-2'}} kN</span><br>
                                    <span>Mz: {{reaction.value.Mz | number:'1.2-2'}} kNm</span>
                                </div>
                           </div>
                        </li>
                    </ul>
                </div>
            </div>

             <!-- Placeholder inicial -->
            <div *ngIf="!results && !errorResult && !isLoading" class="flex items-center justify-center h-full bg-gray-50 rounded-lg border-2 border-dashed">
                <p class="text-gray-500">Define el modelo y haz clic en "Calcular Resultados".</p>
            </div>
            <div *ngIf="isLoading" class="flex items-center justify-center h-full bg-gray-50 rounded-lg">
                <p class="text-gray-600 animate-pulse">Realizando análisis matricial...</p>
            </div>
        </div>
    </main>
</div>