<!-- Main Grid Layout -->
<div class="grid h-screen grid-cols-1 grid-rows-[auto_1fr] md:grid-cols-[450px_1fr] md:grid-rows-1 gap-4 p-4 bg-gray-100 font-sans">

    <aside class="bg-white p-4 rounded-lg shadow-lg overflow-y-auto flex flex-col gap-4">
        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Analysis Parameters</h2>


        <div class="space-y-3 p-3 border rounded-lg bg-gray-50/50">
            <h3 class="font-semibold text-gray-700">Beam Properties</h3>
            <div>
                <label for="beamLength" class="block text-sm font-medium text-gray-600">Length (m)</label>
                <input type="number" id="beamLength" [(ngModel)]="beamLength" (change)="redrawKonva()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="beamE" class="block text-sm font-medium text-gray-600">Young's Modulus (E) [Pa]</label>
                <input type="text" id="beamE" [(ngModel)]="beamE" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="beamI" class="block text-sm font-medium text-gray-600">Moment of Inertia (I) [m⁴]</label>
                <input type="text" id="beamI" [(ngModel)]="beamI" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
        </div>


        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Add Support</h3>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label for="supportPos" class="block text-sm font-medium text-gray-600">Position (m)</label>
                    <input type="number" id="supportPos" [(ngModel)]="supportPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="supportType" class="block text-sm font-medium text-gray-600">Type</label>
                    <select id="supportType" [(ngModel)]="supportType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        <option value="PINNED">Pinned</option>
                        <option value="ROLLER">Roller</option>
                        <option value="FIXED">Fixed</option>
                    </select>
                </div>
            </div>
            <button (click)="addSupport()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Add Support</button>
            @if (supports.length > 0) {
              <ul class="mt-2 space-y-1 text-xs">
                @for (support of supports; track i; let i = $index) {
                  <li class="flex justify-between items-center bg-gray-100 p-1.5 rounded-md">
                    <span>{{ support.type }} @ {{ support.position }}m</span>
                    <button (click)="deleteSupport(i)" class="text-red-500 hover:text-red-700 font-bold px-2">✕</button>
                  </li>
                }
              </ul>
            }       
        </div>


        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Add Point Load</h3>
            <div class="grid grid-cols-2 gap-2">
                 <div>
                    <label for="loadPos" class="block text-sm font-medium text-gray-600">Position (m)</label>
                    <input type="number" id="loadPos" [(ngModel)]="loadPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="loadMag" class="block text-sm font-medium text-gray-600">Magnitude (kN)</label>
                    <input type="number" id="loadMag" [(ngModel)]="loadMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Positive downwards">
                </div>
            </div>
            <button (click)="addPointLoad()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Add Load</button>
            @if (pointLoads.length > 0) {
              <ul class="mt-2 space-y-1 text-xs">
                @for (load of pointLoads; track i; let i = $index) {
                  <li class="flex justify-between items-center bg-gray-100 p-1.5 rounded-md">
                    <span>{{ load.magnitude }}kN @ {{ load.position }}m</span>
                    <button (click)="deletePointLoad(i)" class="text-red-500 hover:text-red-700 font-bold px-2">✕</button>
                  </li>
                }
              </ul>
            }        
        </div>


        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Add Point Moment</h3>
            <div class="grid grid-cols-2 gap-2">
                 <div>
                    <label for="momentPos" class="block text-sm font-medium text-gray-600">Position (m)</label>
                    <input type="number" id="momentPos" [(ngModel)]="momentPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="momentMag" class="block text-sm font-medium text-gray-600">Magnitude (kNm)</label>
                    <input type="number" id="momentMag" [(ngModel)]="momentMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Counter-clockwise positive">
                </div>
            </div>
            <button (click)="addPointMoment()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Add Moment</button>
            @if (pointMoments.length > 0) {
              <ul class="mt-2 space-y-1 text-xs">
                @for (moment of pointMoments; track i; let i = $index) {
                  <li class="flex justify-between items-center bg-gray-100 p-1.5 rounded-md">
                    <span>{{ moment.magnitude }}kN @ {{ moment.position }}m</span>
                    <button (click)="deletePointMoment(i)" class="text-red-500 hover:text-red-700 font-bold px-2">✕</button>
                  </li>
                }
              </ul>
            }        
        </div>


        <div class="space-y-2 p-3 border rounded-lg">
            <h3 class="font-semibold text-gray-700">Add Distributed Load</h3>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium text-gray-600">Start Pos. (m)</label>
                    <input type="number" [(ngModel)]="distLoadStartPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">End Pos. (m)</label>
                    <input type="number" [(ngModel)]="distLoadEndPos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">Start Mag. (kN/m)</label>
                    <input type="number" [(ngModel)]="distLoadStartMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">End Mag. (kN/m)</label>
                    <input type="number" [(ngModel)]="distLoadEndMag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </div>
            <button (click)="addDistributedLoad()" class="w-full mt-2 bg-slate-200 text-slate-800 py-2 rounded-md hover:bg-slate-300 transition-colors text-sm font-medium">Add Dist. Load</button>
            @if (distributedLoads.length > 0) {
              <ul class="mt-2 space-y-1 text-xs">
                @for (load of distributedLoads; track i; let i = $index) {
                  <li class="flex justify-between items-center bg-gray-100 p-1.5 rounded-md">
                    <span>{{ load.start_magnitude }}kN @ {{ load.end_magnitude }}kN @ {{ load.start_position }}m @ {{ load.end_position }}m</span>
                    <button (click)="deleteDistributedLoad(i)" class="text-red-500 hover:text-red-700 font-bold px-2">✕</button>
                  </li>
                }
              </ul>
            }        
        </div>

 
        <div class="mt-auto pt-4 border-t space-y-2">
            <button (click)="saveModel()" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-md">
        Save Model
        </button>
            <button (click)="calculate()" [disabled]="isLoading" class="w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition disabled:bg-blue-400 disabled:cursor-not-allowed shadow-md">
                {{ isLoading ? 'Calculating...' : 'Calculate Results' }}
            </button>
             <button (click)="resetModel()" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-md">
                Reset Model
            </button>
        </div>
    </aside>


    <main class="bg-white p-4 rounded-lg shadow-lg overflow-y-auto flex flex-col gap-4">

        <div class="flex border-b">
            <button (click)="showModelView()" 
                    [ngClass]="{'border-blue-500 text-blue-600': currentView === 'model', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'model'}"
                    class="py-2 px-4 font-medium text-center border-b-2 transition-colors">
                Model Visualization
            </button>
            <button (click)="showResultsView()" 
                    [disabled]="!results && !errorResult"
                    [ngClass]="{'border-blue-500 text-blue-600': currentView === 'results', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': currentView !== 'results'}"
                    class="py-2 px-4 font-medium text-center border-b-2 transition-colors disabled:text-gray-300 disabled:cursor-not-allowed">
                Analysis Results
            </button>
        </div>


        <div [hidden]="currentView !== 'model'" class="flex flex-col gap-4 flex-grow">
            <h2 class="text-xl font-bold text-gray-800">Beam Model</h2>

            <div #konvaContainer class="w-full flex-grow bg-gray-50 border rounded-lg min-h-[300px]"></div>
        </div>

  
        <div [hidden]="currentView !== 'results'" class="flex-grow flex flex-col min-h-[400px]">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Analysis Results</h2>
            

            @if (errorResult) {
                <div class="p-4 mb-4 text-sm text-red-800 bg-red-100 rounded-lg" role="alert">
                    <span class="font-bold">Calculation Error:</span> {{ errorResult }}
                </div>
        }

             @if (results && !errorResult) { 
                <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="relative h-64 border rounded-md p-2"><canvas #shearChartCanvas></canvas></div>
                    <div class="relative h-64 border rounded-md p-2"><canvas #momentChartCanvas></canvas></div>
                    <div class="relative h-64 border rounded-md p-2"><canvas #deflectionChartCanvas></canvas></div>
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <h3 class="font-semibold mb-2">Reactions at Supports</h3>
                        <ul class="text-sm space-y-2 font-mono">
                            @for (reaction of (results.reactions | keyvalue); track reaction.key) {
                                <li>
                                    <div class="bg-gray-200/60 p-2 rounded-md">
                                        <div class="font-bold">&#64; {{reaction.key | number:'1.2-2'}} m</div>
                                        <div class="pl-2">
                                            <span>Fx: {{reaction.value.Fx | number:'1.2-2'}} kN</span><br>
                                            <span>Fy: {{reaction.value.Fy | number:'1.2-2'}} kN</span><br>
                                            <span>Mz: {{reaction.value.Mz | number:'1.2-2'}} kNm</span>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
            @if (!results && !errorResult && !isLoading) {
                <div  class="flex items-center justify-center h-full bg-gray-50 rounded-lg border-2 border-dashed">
                    <p class="text-gray-500">Define the model and click "Calculate Results".</p>
                </div>
            }
            <!-- Loading Indicator -->
            @if (isLoading) {   
                <div class="flex items-center justify-center h-full bg-gray-50 rounded-lg">
                    <p class="text-gray-600 animate-pulse">Performing matrix analysis...</p>
                </div>
            }
        </div>
    </main>
</div>
